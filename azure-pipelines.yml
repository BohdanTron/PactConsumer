trigger:
  branches:
    include:
      - master

variables:
  PACT_BROKER_BASE_URL: $(PACTFLOW_BASE_URL)
  PACT_BROKER_TOKEN: $(PACTFLOW_TOKEN)
  GIT_COMMIT: $(Build.SourceVersion)
  BRANCH_NAME: $(Build.SourceBranchName)
  BUILD_URL: "https://dev.azure.com/tronbodya/$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '8.0.x'
  displayName: 'Setup .NET'

- task: DotNetCoreCLI@2
  inputs:
    command: 'restore'
  displayName: 'Restore dependencies'

- task: DotNetCoreCLI@2
  inputs:
    command: 'build'
    arguments: '--configuration Release'
  displayName: 'Build'

- task: DotNetCoreCLI@2
  inputs:
    command: 'test'
    projects: 'Consumer.Contract.Tests/Consumer.Contract.Tests.csproj'
    arguments: '--no-build --configuration Release --verbosity normal'
  displayName: 'Run Consumer Tests'

- script: |
    docker run --rm \
      -v $(System.DefaultWorkingDirectory)/Consumer.Contract.Tests/pacts:/pacts \
      pactfoundation/pact-cli:latest \
      publish /pacts \
      --consumer-app-version $(GIT_COMMIT) \
      --branch $(BRANCH_NAME) \
      --build-url $(BUILD_URL) \
      --broker-base-url $(PACT_BROKER_BASE_URL) \
      --broker-token $(PACT_BROKER_TOKEN)
  displayName: 'Publish Consumer Tests to PactFlow'

- script: |
    docker run --rm \
      pactfoundation/pact-cli:latest \
      broker can-i-deploy \
      --pacticipant StudentApiClient \
      --version $(GIT_COMMIT) \
      --to-environment stage \
      --broker-base-url $(PACT_BROKER_BASE_URL) \
      --broker-token $(PACT_BROKER_TOKEN) \
      --retry-while-unknown 5 \
      --retry-interval 10
  displayName: 'Can I Deploy (Consumer)?'

- script: |
    docker run --rm \
      pactfoundation/pact-cli:latest \
      broker record-deployment \
      --pacticipant StudentApiClient \
      --version $(GIT_COMMIT) \
      --environment stage \
      --broker-base-url $(PACT_BROKER_BASE_URL) \
      --broker-token $(PACT_BROKER_TOKEN)
  displayName: 'Record Consumer Deployment in Stage'
